@echo off
chcp 65001 >nul
title MLSharp-3D-Maker - 统一启动

cls
echo ================================================================
echo                                                                
echo            ███╗   ██╗██╗   ██╗ ██████╗ ██╗   ██╗██╗███████╗
echo            ████╗  ██║██║   ██║██╔═══██╗██║   ██║██║██╔════╝
echo            ██╔██╗ ██║██║   ██║██║   ██║██║   ██║██║███████╗
echo            ██║╚██╗██║╚██╗ ██╔╝██║   ██║╚██╗ ██╔╝██║╚════██║
echo            ██║ ╚████║ ╚████╔╝ ╚██████╔╝ ╚████╔╝ ██║███████║
echo            ╚═╝  ╚═══╝  ╚═══╝   ╚═════╝   ╚═══╝  ╚═╝╚══════╝
echo                                                                
echo ================================================================
echo.
echo                           3D 模型生成工具
echo.
echo ================================================================
echo.
echo [信息] 正在初始化...
echo.

cd /d "%~dp0"

REM 检查 Python 环境
if not exist "python_env\python.exe" (
    echo [错误] 未找到 Python 环境!
    echo.
    echo ================================================================
    echo 错误详情
    echo ================================================================
    echo.
    echo Python 环境不存在: python_env\python.exe
    echo.
    echo 可能的原因:
    echo   1. Python 环境未正确安装
    echo   2. 文件夹结构被破坏
    echo   3. 文件被误删或移动
    echo.
    echo 解决方案:
    echo   1. 重新下载完整的程序包
    echo   2. 检查 python_env 文件夹是否存在
    echo   3. 联系技术支持
    echo.
    echo ================================================================
    echo.
    pause
    exit /b 1
)

echo [成功] Python 环境已找到
echo.

REM 检查 app.py
if not exist "app.py" (
    echo [错误] 未找到主程序文件!
    echo.
    echo ================================================================
    echo 错误详情
    echo ================================================================
    echo.
    echo 主程序文件不存在: app.py
    echo.
    echo 解决方案:
    echo   1. 确保 app.py 文件在同一目录下
    echo   2. 重新下载程序
    echo.
    echo ================================================================
    echo.
    pause
    exit /b 1
)

echo [成功] 主程序文件已找到
echo.

REM 检查模型文件
if not exist "model_assets\sharp_2572gikvuh.pt" (
    echo [警告] 未找到模型文件!
    echo.
    echo ================================================================
    echo 警告
    echo ================================================================
    echo.
    echo 模型文件不存在: model_assets\sharp_2572gikvuh.pt
    echo.
    echo 程序可能无法正常运行,请确保模型文件已正确下载
    echo.
    echo ================================================================
    echo.
)

echo [信息] 正在启动程序...
echo.
echo ================================================================
echo 系统信息
echo ================================================================
echo.
echo 支持模式:
echo   [OK] NVIDIA GPU (CUDA)
echo   [OK] AMD GPU (ROCm)
echo   [OK] Intel GPU (CPU 回退)
echo   [OK] CPU 模式
echo.
echo ================================================================
echo.
echo [提示] 浏览器将自动打开...
echo [提示] 按 Ctrl+C 可停止服务
echo.
echo ================================================================
echo.

python_env\python.exe app.py

REM 错误处理
if %errorlevel% neq 0 (
    echo.
    echo ================================================================
    echo 启动失败!
    echo ================================================================
    echo.
    echo 错误代码: %errorlevel%
    echo.
    echo 可能的原因:
    echo   1. Python 环境未正确安装
    echo   2. 依赖库缺失或不兼容
    echo   3. 模型文件不存在或已损坏
    echo   4. 端口 8000 被占用
    echo   5. 系统资源不足(内存/显存)
    echo   6. 显卡驱动问题
    echo.
    echo 解决方案:
    echo   1. 查看上面的详细错误信息
    echo   2. 关闭其他占用端口 8000 的程序
    echo   3. 检查显卡驱动是否正确安装
    echo   4. 重启计算机
    echo   5. 查看日志文件 logs/ 中的详细信息
    echo.
    echo ================================================================
    echo.
    pause
)